<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Learning Dashboard - AI Education System</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: Arial, sans-serif;
    }
    
    body {
      background: #f8f9fa;
      color: #333;
    }
    
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      background: white;
      border-bottom: 1px solid #ccc;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .logo-section {
      display: flex;
      align-items: center;
    }
    
    .logo-section img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      margin-right: 10px;
    }
    
    nav a {
      margin-left: 20px;
      text-decoration: none;
      color: black;
      font-weight: 500;
    }
    
    .user-info {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .user-badge {
      background: #ffc107;
      color: black;
      padding: 5px 12px;
      border-radius: 15px;
      font-size: 0.9rem;
      font-weight: bold;
    }
    
    .main-container {
      display: flex;
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
      gap: 30px;
    }
    
    .content-area {
      flex: 2;
      background: white;
      border-radius: 10px;
      padding: 30px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .chat-area {
      flex: 1;
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      height: fit-content;
      position: sticky;
      top: 20px;
    }
    
    .section-header {
      display: flex;
      justify-content: between;
      align-items: center;
      margin-bottom: 25px;
      border-bottom: 2px solid #ffc107;
      padding-bottom: 10px;
    }
    
    .section-header h2 {
      color: #333;
      font-size: 1.8rem;
    }
    
    .progress-indicator {
      background: #e9ecef;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 25px;
      border-left: 4px solid #ffc107;
    }
    
    .progress-bar {
      width: 100%;
      height: 8px;
      background: #e9ecef;
      border-radius: 4px;
      margin: 10px 0;
      overflow: hidden;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #ffc107, #ff8f00);
      border-radius: 4px;
      transition: width 0.8s ease;
    }
    
    .learning-objectives {
      background: #e8f5e8;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
      border-left: 4px solid #28a745;
    }
    
    .learning-objectives h3 {
      color: #28a745;
      margin-bottom: 15px;
    }
    
    .objective-item {
      display: flex;
      align-items: center;
      margin: 8px 0;
      padding: 5px 0;
    }
    
    .objective-item::before {
      content: "üéØ";
      margin-right: 10px;
    }
    
    .content-section {
      margin: 30px 0;
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid #e9ecef;
    }
    
    .content-header {
      background: #f8f9fa;
      padding: 15px 20px;
      border-bottom: 1px solid #e9ecef;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background 0.3s ease;
    }
    
    .content-header:hover {
      background: #e9ecef;
    }
    
    .content-header.active {
      background: #ffc107;
      color: black;
    }
    
    .content-body {
      padding: 20px;
      display: none;
      background: white;
    }
    
    .content-body.active {
      display: block;
    }
    
    .expand-icon {
      transition: transform 0.3s ease;
    }
    
    .content-header.active .expand-icon {
      transform: rotate(180deg);
    }
    
    .code-example {
      background: #f8f9fa;
      border: 1px solid #e9ecef;
      border-radius: 5px;
      padding: 15px;
      margin: 15px 0;
      font-family: 'Courier New', monospace;
      overflow-x: auto;
    }
    
    .example-card {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      border-radius: 8px;
      padding: 15px;
      margin: 15px 0;
    }
    
    .example-card h4 {
      color: #856404;
      margin-bottom: 10px;
    }
    
    .best-practice {
      background: #d1ecf1;
      border: 1px solid #bee5eb;
      border-radius: 8px;
      padding: 15px;
      margin: 10px 0;
      border-left: 4px solid #17a2b8;
    }
    
    .chat-container {
      height: 400px;
      border: 1px solid #e9ecef;
      border-radius: 8px;
      overflow-y: auto;
      padding: 15px;
      margin-bottom: 15px;
      background: #f8f9fa;
    }
    
    .chat-message {
      margin: 10px 0;
      padding: 10px 15px;
      border-radius: 15px;
      max-width: 80%;
    }
    
    .user-message {
      background: #ffc107;
      color: black;
      margin-left: auto;
      text-align: right;
    }
    
    .ai-message {
      background: #e9ecef;
      color: #333;
    }
    
    .chat-input-container {
      display: flex;
      gap: 10px;
    }
    
    .chat-input {
      flex: 1;
      padding: 10px;
      border: 1px solid #e9ecef;
      border-radius: 20px;
      outline: none;
    }
    
    .chat-input:focus {
      border-color: #ffc107;
    }
    
    .send-btn {
      background: #ffc107;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
    }
    
    .send-btn:hover {
      background: #ff8f00;
    }
    
    .action-buttons {
      display: flex;
      gap: 15px;
      margin: 30px 0;
      justify-content: center;
      flex-wrap: wrap;
    }
    
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      text-decoration: none;
      display: inline-block;
      text-align: center;
      transition: all 0.3s ease;
    }
    
    .btn-primary {
      background: #ffc107;
      color: black;
      border: 1px solid #000;
    }
    
    .btn-primary:hover {
      background: #ff8f00;
      transform: translateY(-2px);
    }
    
    .btn-secondary {
      background: #6c757d;
      color: white;
    }
    
    .btn-secondary:hover {
      background: #545b62;
      transform: translateY(-2px);
    }
    
    .loading {
      text-align: center;
      padding: 40px;
    }
    
    .loading-spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #ffc107;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .typing-indicator {
      display: none;
      padding: 10px 15px;
      background: #e9ecef;
      border-radius: 15px;
      max-width: 80px;
      margin: 10px 0;
    }
    
    .typing-indicator::after {
      content: "‚óè‚óè‚óè";
      animation: typing 1.5s infinite;
    }
    
    @keyframes typing {
      0%, 60% { content: "‚óè‚óè‚óè"; }
      40% { content: "‚óè‚óè"; }
      80% { content: "‚óè"; }
    }
    
    .quiz-section {
      background: #fff3cd;
      border: 2px solid #ffc107;
      border-radius: 10px;
      padding: 20px;
      margin: 30px 0;
      text-align: center;
    }
    
    .quiz-section h3 {
      color: #856404;
      margin-bottom: 15px;
    }
    
    @media (max-width: 768px) {
      .main-container {
        flex-direction: column;
        gap: 20px;
      }
      
      .chat-area {
        position: static;
      }
      
      .action-buttons {
        flex-direction: column;
        align-items: center;
      }
      
      .btn {
        width: 100%;
        max-width: 300px;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="logo-section">
      <img src="../image/logo.svg" alt="Logo">
      <strong>AI Education System</strong>
    </div>
    <nav>
      <a href="../index.html">Home</a>
      <a href="course.html">Courses</a>
      <a href="profile.html">Profile</a>
      <a href="#">About</a>
    </nav>
    <div class="user-info">
      <span id="user-name">Selamat Datang!</span>
      <span id="user-badge" class="user-badge">Learner</span>
    </div>
  </header>

  <!-- Loading State -->
  <div id="loading-section" style="display: none;">
    <div class="loading">
      <div class="loading-spinner"></div>
      <h3>Membuat Material Belajar Pribadi Anda...</h3>
      <p>AI kami membuat materi yang disesuaikan dengan level dan spesialisasi Anda.</p>
    </div>
  </div>

  <!-- Main Learning Dashboard -->
  <div id="learning-dashboard" class="main-container">
    <!-- Content Area -->
    <div class="content-area">
      <!-- Progress Section -->
      <div class="progress-indicator">
        <h3 id="progress-title">Kemajuan Belajar Anda</h3>
        <div class="progress-bar">
          <div id="progress-fill" class="progress-fill" style="width: 0%;"></div>
        </div>
        <p id="progress-text">Memulai perjalanan belajar pribadi Anda...</p>
      </div>

      <!-- Learning Material Header -->
      <div class="section-header">
        <h2 id="material-title">Memuat Materi Pribadi Anda...</h2>
      </div>

      <!-- Learning Objectives -->
      <div id="objectives-section" class="learning-objectives">
        <h3>üéØ Tujuan Belajar</h3>
        <div id="objectives-list">
          <!-- Dynamic objectives will be loaded here -->
        </div>
      </div>

      <!-- Prerequisites -->
      <div id="prerequisites-section" style="display: none;">
        <div class="content-section">
          <div class="content-header">
            <h3>üìã Prasyarat</h3>
          </div>
          <div class="content-body">
            <div id="prerequisites-list">
              <!-- Dynamic prerequisites will be loaded here -->
            </div>
          </div>
        </div>
      </div>

      <!-- Theory Overview -->
      <div class="content-section">
        <div class="content-header active" onclick="toggleSection(this)">
          <h3>üìö Pengantar Teori</h3>
          <span class="expand-icon">‚ñº</span>
        </div>
        <div class="content-body active">
          <div id="theory-content">
            <!-- Dynamic theory content will be loaded here -->
          </div>
        </div>
      </div>

      <!-- Practical Examples -->
      <div class="content-section">
        <div class="content-header" onclick="toggleSection(this)">
          <h3>üí° Contoh Praktis</h3>
          <span class="expand-icon">‚ñº</span>
        </div>
        <div class="content-body">
          <div id="examples-content">
            <!-- Dynamic examples will be loaded here -->
          </div>
        </div>
      </div>

      <!-- Best Practices -->
      <div class="content-section">
        <div class="content-header" onclick="toggleSection(this)">
          <h3>‚úÖ Best Practices</h3>
          <span class="expand-icon">‚ñº</span>
        </div>
        <div class="content-body">
          <div id="practices-content">
            <!-- Dynamic best practices will be loaded here -->
          </div>
        </div>
      </div>

      <!-- Quiz Section -->
      <div class="quiz-section">
        <h3>üß† Siap untuk Menguji Pengetahuan Anda?</h3>
        <p>Selesaikan materi di atas, lalu ambil kuis untuk membuktikan pemahaman Anda.</p>
        <button id="take-quiz-btn" class="btn btn-primary" onclick="takeQuiz()" disabled>
          Kuis Pengetahuan
        </button>
      </div>

      <!-- Action Buttons -->
      <div class="action-buttons">
        <button class="btn btn-secondary" onclick="goBack()">‚Üê Kembali ke Kursus</button>
        <button class="btn btn-primary" onclick="viewProgress()">üìä Lihat Kemajuan</button>
        <button class="btn btn-secondary" onclick="nextModule()" style="display: none;" id="next-module-btn">
          Modul Berikutnya ‚Üí
        </button>
      </div>
    </div>

    <!-- AI Tutor Chat Area -->
    <div class="chat-area">
      <h3>ü§ñ Tutor AI</h3>
      <p style="margin-bottom: 15px; color: #666; font-size: 0.9rem;">
        Tanya pertanyaan tentang materi atau minta penjelasan tentang topik apa saja.
      </p>
      
      <div id="chat-container" class="chat-container">
        <div class="ai-message">
          <strong>Tutor AI:</strong> Halo! Saya di sini untuk membantu Anda memahami materi. Silakan tanya saya tentang apa saja yang Anda pelajari!
        </div>
      </div>
      
      <div class="typing-indicator" id="typing-indicator">
        AI sedang mengetik...
      </div>
      
      <div class="chat-input-container">
        <input 
          type="text" 
          id="chat-input" 
          class="chat-input" 
          placeholder="Tanya tentang materi..."
          onkeypress="handleChatKeyPress(event)"
        />
        <button class="send-btn" onclick="sendMessage()">‚û§</button>
      </div>
      
      <div style="margin-top: 15px; font-size: 0.8rem; color: #666;">
        üí° <strong>Coba tanya:</strong><br>
        ‚Ä¢ "Jelaskan konsep ini dalam istilah yang lebih sederhana"<br>
        ‚Ä¢ "Berikan saya lebih banyak contoh"<br>
        ‚Ä¢ "Bagaimana ini digunakan dalam proyek nyata?"
      </div>
    </div>
  </div>

  <script>
    // Global variables
    let currentUser = null;
    let learningMaterial = null;
    let chatHistory = [];
    let materialProgress = 0;
    const API_BASE_URL = 'http://localhost:8000/api';

    // Initialize learning dashboard
    document.addEventListener('DOMContentLoaded', function() {
      loadUserInfo();
      loadLearningMaterial();
    });

    // Load user information from URL parameters
    function loadUserInfo() {
      const urlParams = new URLSearchParams(window.location.search);
      
      currentUser = {
        user_id: urlParams.get('user_id') || 'demo-user',
        username: urlParams.get('username') || 'Learner',
        specialization: urlParams.get('specialization') || 'data_scientist',
        level: urlParams.get('level') || 'beginner',
        score: parseInt(urlParams.get('score')) || 0
      };

      // Update UI with user info
      document.getElementById('user-name').textContent = `Welcome, ${currentUser.username}!`;
      
      let specializationDisplay;
      switch(currentUser.specialization) {
        case 'data_engineer':
          specializationDisplay = 'Data Engineer';
          break;
        case 'data_analyst':
          specializationDisplay = 'Data Analyst';
          break;
        case 'data_scientist':
        default:
          specializationDisplay = 'Data Scientist';
          break;
      }
      document.getElementById('user-badge').textContent = `${specializationDisplay} - ${currentUser.level.charAt(0).toUpperCase() + currentUser.level.slice(1)}`;
    }

    // Load learning material
    async function loadLearningMaterial() {
      document.getElementById('loading-section').style.display = 'block';
      document.getElementById('learning-dashboard').style.display = 'none';

      try {
        // Try to fetch from backend
        const response = await makeAPICall(`/learning/start/${currentUser.user_id}`);
        if (response && response.material) {
          learningMaterial = response.material;
        } else {
          throw new Error('No material from backend');
        }
      } catch (error) {
        console.log('Backend unavailable, generating demo material');
        learningMaterial = generateDemoMaterial();
      }

      displayLearningMaterial();
      document.getElementById('loading-section').style.display = 'none';
      document.getElementById('learning-dashboard').style.display = 'flex';
    }

    // Generate demo learning material
    function generateDemoMaterial() {
      const isDataEngineer = currentUser.specialization === 'data_engineer';
      const isDataAnalyst = currentUser.specialization === 'data_analyst';
      
      if (isDataEngineer) {
        return {
          id: 'demo-material-de',
          title: 'Data Pipeline Fundamentals',
          subtitle: 'Building robust and scalable data processing systems',
          learning_objectives: [
            'Mengerti komponen dari sebuah data pipeline',
            'Belajar tentang proses ETL vs ELT',
            'Menguasai validasi data dan pemeriksaan kualitas',
            'Menerapkan penanganan kesalahan dan pemantauan',
            'Merancang untuk skalabilitas dan performa'
          ],
          prerequisites: [
            'Pemahuan dasar tentang database',
            'Kenalan dengan SQL',
            'Pemrograman Python dasar',
            'Pemahuan tentang format data (JSON, CSV, Parquet)'
          ],
          content: {
            theory: {
              overview: `Data pipelines are the backbone of modern data infrastructure. They automate the flow of data from various sources to destinations, ensuring data is clean, transformed, and available for analysis. A well-designed pipeline handles data ingestion, processing, validation, and delivery with reliability and efficiency.
              
              The key principles of effective data pipelines include: automation, monitoring, scalability, fault tolerance, and data quality assurance. Understanding these principles is crucial for building systems that can handle real-world data challenges.`,
              key_concepts: [
                'Data Ingestion: Mengumpulkan data dari berbagai sumber (APIs, databases, files)',
                'Data Transformation: Membersihkan, memformat, dan memperkaya data',
                'Data Validation: Memastikan data kualitas dan integritas',
                'Data Loading: Menyimpan data yang diproses di sistem tujuan',
                'Monitoring: Melacak performa pipeline dan mendeteksi masalah',
                'Orchestration: Mengelola dependensi dan penjadwalan'
              ]
            },
            practical_examples: [
              {
                title: 'Membangun Pipeline ETL Sederhana',
                description: 'Buat sebuah pipeline yang mengekstrak data pengguna dari database, mengubahnya dengan menambahkan bidang yang dihitung, dan memuatnya ke dalam data warehouse.',
                code_snippet: `import pandas as pd
from sqlalchemy import create_engine

def extract_user_data(connection):
    query = "SELECT user_id, signup_date, last_login FROM users"
    return pd.read_sql(query, connection)

def transform_user_data(df):
    df['days_since_signup'] = (pd.Timestamp.now() - df['signup_date']).dt.days
    df['is_active'] = df['last_login'] > (pd.Timestamp.now() - pd.Timedelta(days=30))
    return df

def load_to_warehouse(df, warehouse_connection):
    df.to_sql('user_metrics', warehouse_connection, if_exists='replace', index=False)

# Execute pipeline
source_engine = create_engine('postgresql://source_db')
warehouse_engine = create_engine('postgresql://warehouse_db')

user_data = extract_user_data(source_engine)
transformed_data = transform_user_data(user_data)
load_to_warehouse(transformed_data, warehouse_engine)`,
                explanation: 'Contoh ini menunjukkan sebuah proses ETL sederhana menggunakan Python dan pandas. Pipeline ini mengekstrak data pengguna, menambahkan metrik yang dihitung, dan memuat hasilnya ke dalam data warehouse. Dalam produksi, Anda akan menambahkan penanganan kesalahan, logging, dan penjadwalan.'
              },
              {
                title: 'Implementasi Validasi Data',
                description: 'Implementasi pemeriksaan kualitas data untuk memastikan keandalan pipeline.',
                code_snippet: `def validate_data(df):
    validation_results = {
        'total_records': len(df),
        'null_user_ids': df['user_id'].isnull().sum(),
        'duplicate_users': df['user_id'].duplicated().sum(),
        'future_signup_dates': (df['signup_date'] > pd.Timestamp.now()).sum()
    }
    
    # Define validation rules
    if validation_results['null_user_ids'] > 0:
        raise ValueError(f"Found {validation_results['null_user_ids']} null user IDs")
    
    if validation_results['duplicate_users'] > 0:
        raise ValueError(f"Found {validation_results['duplicate_users']} duplicate users")
    
    return validation_results`,
                explanation: 'Data validation is crucial for maintaining data quality. This function checks for common data issues like null values, duplicates, and logical inconsistencies. Implementing such checks prevents bad data from corrupting downstream systems.'
              }
            ],
            best_practices: [
              'Selalu implementasi penanganan kesalahan dan logika retry',
              'Gunakan pemrosesan incremental ketika mungkin untuk meningkatkan efisiensi',
              'Implementasi pelacakan data lineage untuk memahami aliran data',
              'Mengatur monitoring dan pemberitahuan untuk kegagalan pipeline',
              'Merancang operasi idempotent untuk menangani re-runs dengan aman',
              'Gunakan format data yang sesuai (Parquet untuk analisis, Avro untuk streaming)',
              'Implementasi logging yang tepat untuk debugging dan audit',
              'Test pipelines with realistic data volumes and edge cases'
            ]
          }
        };
      } else if (isDataAnalyst) {
        return {
          id: 'demo-material-da',
          title: 'SQL Fundamentals untuk Analisis Data',
          subtitle: 'Menguasai SQL queries untuk mengekstrak insight dari data',
          learning_objectives: [
            'Mengerti sintaksis SQL dan struktur query dasar',
            'Belajar untuk memfilter dan mengurutkan data secara efektif',
            'Menguasai fungsi agregasi dan pengelompokan',
            'Membuat joins untuk menggabungkan data dari beberapa tabel',
            'Menulis subqueries dan window functions untuk analisis lanjutan'
          ],
          prerequisites: [
            'Pemahuan dasar tentang database dan tabel',
            'Kenalan dengan perangkat lunak spreadsheet (Excel/Google Sheets)',
            'Pemahuan tentang operasi matematika dasar',
            'Pengetahuan tentang tipe data (angka, teks, tanggal)'
          ],
          content: {
            theory: {
              overview: `SQL (Structured Query Language) adalah fondasi dari analisis data. Ini memungkinkan Anda untuk mengambil, memfilter, mengagregasi, dan memanipulasi data yang disimpan di database relasional. Untuk analis data, SQL sangat penting untuk mengekstrak insight, membuat laporan, dan menjawab pertanyaan bisnis melalui eksplorasi data.
              
              SQL mengikuti pendekatan deklaratif - Anda menentukan apa yang Anda inginkan, bukan bagaimana untuk mendapatkannya. Ini membuatnya kuat untuk tugas analisis data seperti menghitung metrik, mengidentifikasi tren, dan membuat ringkasan yang memacu keputusan bisnis.`,
              key_concepts: [
                'SELECT statements: Mengambil kolom dan baris tertentu',
                'WHERE clauses: Memfilter data berdasarkan kondisi',
                'GROUP BY: Mengagregasi data untuk statistik ringkasan',
                'JOIN operations: Menggabungkan data dari beberapa tabel',
                'Aggregate functions: COUNT, SUM, AVG, MIN, MAX',
                'Window functions: Analisis lanjutan dan peringkat'
              ]
            },
            practical_examples: [
              {
                title: 'Eksplorasi Data Dasar',
                description: 'Belajar untuk menjelajahi dan memahami dataset Anda menggunakan query SQL dasar.',
                code_snippet: `-- Get overview of the sales table
SELECT COUNT(*) as total_records,
       MIN(order_date) as earliest_date,
       MAX(order_date) as latest_date,
       COUNT(DISTINCT customer_id) as unique_customers
FROM sales;

-- Find top 10 customers by total purchase amount
SELECT customer_id,
       COUNT(*) as order_count,
       SUM(amount) as total_spent,
       AVG(amount) as avg_order_value
FROM sales
GROUP BY customer_id
ORDER BY total_spent DESC
LIMIT 10;

-- Analyze sales trends by month
SELECT DATE_TRUNC('month', order_date) as month,
       COUNT(*) as orders,
       SUM(amount) as revenue,
       AVG(amount) as avg_order_value
FROM sales
WHERE order_date >= '2023-01-01'
GROUP BY month
ORDER BY month;`,
                explanation: 'Query ini menunjukkan teknik analisis data dasar: mendapatkan gambaran data, mengidentifikasi pemain teratas, dan menganalisis tren seiring waktu. Ini adalah titik awal umum untuk kebanyakan proyek analisis bisnis.'
              },
              {
                title: 'Advanced Data Analysis with Joins',
                description: 'Menggabungkan data dari beberapa tabel untuk membuat insight bisnis yang komprehensif.',
                code_snippet: `-- Customer analysis with demographic data
SELECT c.customer_id,
       c.customer_name,
       c.age_group,
       c.location,
       COUNT(s.order_id) as total_orders,
       SUM(s.amount) as total_spent,
       AVG(s.amount) as avg_order_value,
       MAX(s.order_date) as last_purchase_date
FROM customers c
LEFT JOIN sales s ON c.customer_id = s.customer_id
WHERE s.order_date >= CURRENT_DATE - INTERVAL '12 months'
GROUP BY c.customer_id, c.customer_name, c.age_group, c.location
HAVING COUNT(s.order_id) > 0
ORDER BY total_spent DESC;

-- Product performance analysis
SELECT p.product_name,
       p.category,
       COUNT(s.order_id) as times_sold,
       SUM(s.quantity) as total_quantity,
       SUM(s.amount) as total_revenue,
       AVG(s.amount) as avg_sale_price
FROM products p
JOIN sales s ON p.product_id = s.product_id
GROUP BY p.product_id, p.product_name, p.category
ORDER BY total_revenue DESC;`,
                explanation: 'Joins allow you to combine customer, sales, and product data to create comprehensive business insights. This enables deeper analysis of customer behavior, product performance, and business trends.'
              }
            ],
            best_practices: [
              'Selalu mulai dengan query eksplorasi untuk memahami data Anda',
              'Gunakan alias yang berarti untuk tabel dan kolom untuk meningkatkan keterbacaan',
              'Komentari query kompleks Anda untuk menjelaskan logika bisnis',
              'Berikan detail dengan rentang tanggal dan filter untuk meningkatkan performa',
              'Gunakan fungsi agregasi dengan GROUP BY untuk analisis ringkasan',
              'Validasi hasil Anda dengan memeriksa kembali dengan metrik yang diketahui',
              'Uji query pada dataset kecil sebelum menjalankan pada tabel besar',
              'Dokumentasikan proses analisis Anda untuk reproduksi'
            ]
          }
        };
      } else {
        return {
          id: 'demo-material-ds',
          title: 'Analisis Data Eksploratori (EDA)',
          subtitle: 'Mencari insight dan pola dalam data Anda',
          learning_objectives: [
            'Menguasai dasar-dasar analisis data eksploratori',
            'Belajar untuk mengidentifikasi masalah kualitas data',
            'Memahami ukuran statistik dan distribusi',
            'Membuat visualisasi data yang efektif',
            'Mengembangkan insight untuk membimbing pemodelan'
          ],
          prerequisites: [
            'Pengetahuan statistik dasar',
            'Pemrograman Python dasar',
            'Kenalan dengan pandas dan numpy',
            'Pemahuan tentang tipe data dan struktur'
          ],
          content: {
            theory: {
              overview: `Analisis Data Eksploratori (EDA) adalah langkah kritis pertama dalam setiap proyek data science. Ini melibatkan pemeriksaan dan visualisasi data untuk memahami struktur, mengidentifikasi pola, mendeteksi anomali, dan membuat hipotesis. EDA membantu data scientists membuat keputusan yang tepat tentang pemrosesan data, pengembangan fitur, dan pendekatan pemodelan.
              
              Tujuan EDA adalah memaksimalkan insight ke dalam data sambil meminimalkan asumsi. Melalui eksplorasi sistematis, kita dapat menemukan pola tersembunyi, menemukan outlier, memahami hubungan variabel, dan mengevaluasi kualitas data sebelum melanjutkan analisis lanjutan.`,
              key_concepts: [
                'Statistik Deskriptif: Mean, median, mode, standar deviasi, kuartil',
                'Distribusi Data: Memahami distribusi normal, condong, dan multimodal',
                'Analisis Korelasi: Mengidentifikasi hubungan antar variabel',
                'Deteksi Anomali: Menemukan data yang tidak biasa atau ekstrem',
                'Analisis Data yang Hilang: Memahami pola dalam data yang hilang',
                'Hubungan Fitur: Menjelajahi interaksi antar variabel'
              ]
            },
            practical_examples: [
              {
                title: 'Profil Data Dasar',
                description: 'Buat gambaran komprehensif tentang dataset Anda untuk memahami struktur dan kualitas.',
                code_snippet: `import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns

def data_profile(df):
    print("Dataset Shape:", df.shape)
    print("\\nData Types:")
    print(df.dtypes)
    
    print("\\nMissing Values:")
    missing_data = df.isnull().sum()
    print(missing_data[missing_data > 0])
    
    print("\\nBasic Statistics:")
    print(df.describe())
    
    # Visualize missing data pattern
    plt.figure(figsize=(12, 6))
    sns.heatmap(df.isnull(), yticklabels=False, cbar=True, cmap='viridis')
    plt.title('Missing Data Pattern')
    plt.show()

# Example usage
df = pd.read_csv('your_dataset.csv')
data_profile(df)`,
                explanation: 'Profil data memberikan gambaran cepat tentang dataset Anda. Fungsi ini memeriksa tipe data, nilai yang hilang, dan statistik dasar. Visualisasi heatmap membantu mengidentifikasi pola dalam data yang hilang, yang dapat memberikan informasi tentang strategi pembersihan data Anda.'
              },
              {
                title: 'Analisis Korelasi dan Visualisasi',
                description: 'Jelajahi hubungan antar variabel numerik untuk mengidentifikasi potensi prediktor.',
                code_snippet: `def correlation_analysis(df, target_column=None):
    # Calculate correlation matrix
    correlation_matrix = df.corr()
    
    # Create correlation heatmap
    plt.figure(figsize=(12, 10))
    sns.heatmap(correlation_matrix, annot=True, cmap='coolwarm', center=0,
                square=True, linewidths=0.5)
    plt.title('Feature Correlation Matrix')
    plt.show()
    
    # If target column specified, show correlations with target
    if target_column and target_column in df.columns:
        target_corr = correlation_matrix[target_column].sort_values(ascending=False)
        print(f"\\nCorrelations with {target_column}:")
        print(target_corr)
        
        # Visualize target correlations
        plt.figure(figsize=(10, 6))
        target_corr.drop(target_column).plot(kind='barh')
        plt.title(f'Feature Correlations with {target_column}')
        plt.show()

correlation_analysis(df, target_column='target_variable')`,
                explanation: 'Analisis korelasi membantu mengidentifikasi hubungan antar variabel. Korelasi yang kuat dapat menunjukkan masalah multikolinearitas atau mengungkapkan fitur prediktif yang penting. Heatmap memberikan representasi visual dari semua korelasi pasangan.'
              }
            ],
            best_practices: [
              'Selalu mulai dengan memahami data Anda sebelum analisis apa pun',
              'Gunakan berbagai jenis visualisasi untuk menjelajahi berbagai aspek',
              'Perhatikan masalah kualitas data awal dalam proses',
              'Dokumentasikan hasil dan insight Anda selama proses EDA',
              'Pertimbangkan konteks bisnis saat menafsirkan pola',
              'Gunakan tes statistik untuk memvalidasi pola yang diamati',
              'Buat skrip EDA yang dapat direproduksi untuk analisis konsisten',
              'Seimbangkan antara eksplorasi yang mendalam dan analisis paralysis'
            ]
          }
        };
      }
    }

    // Display learning material
    function displayLearningMaterial() {
      // Update title and subtitle
      document.getElementById('material-title').textContent = learningMaterial.title;
      
      // Update progress
      const progress = calculateProgress();
      document.getElementById('progress-fill').style.width = `${progress}%`;
      document.getElementById('progress-text').textContent = `Progress: ${progress}% complete`;
      
      // Display learning objectives
      const objectivesList = document.getElementById('objectives-list');
      objectivesList.innerHTML = learningMaterial.learning_objectives.map(obj => 
        `<div class="objective-item">${obj}</div>`
      ).join('');
      
      // Display prerequisites if available
      if (learningMaterial.prerequisites && learningMaterial.prerequisites.length > 0) {
        document.getElementById('prerequisites-section').style.display = 'block';
        const prerequisitesList = document.getElementById('prerequisites-list');
        prerequisitesList.innerHTML = learningMaterial.prerequisites.map(prereq => 
          `<div class="best-practice">üìã ${prereq}</div>`
        ).join('');
      }
      
      // Display theory content
      displayTheoryContent();
      
      // Display practical examples
      displayPracticalExamples();
      
      // Display best practices
      displayBestPractices();
      
      // Enable quiz button after material is loaded
      document.getElementById('take-quiz-btn').disabled = false;
    }

    // Display theory content
    function displayTheoryContent() {
      const theoryContent = document.getElementById('theory-content');
      const theory = learningMaterial.content.theory;
      
      let content = `<p style="line-height: 1.6; margin-bottom: 20px;">${theory.overview}</p>`;
      
      if (theory.key_concepts) {
        content += `<h4 style="margin: 20px 0 15px 0; color: #333;">üîë Konsep Penting:</h4>`;
        content += theory.key_concepts.map(concept => 
          `<div class="best-practice">üí° ${concept}</div>`
        ).join('');
      }
      
      theoryContent.innerHTML = content;
    }

    // Display practical examples
    function displayPracticalExamples() {
      const examplesContent = document.getElementById('examples-content');
      const examples = learningMaterial.content.practical_examples;
      
      if (!examples || examples.length === 0) {
        examplesContent.innerHTML = '<p>Tidak ada contoh praktis yang tersedia untuk materi ini.</p>';
        return;
      }
      
      let content = '';
      examples.forEach((example, index) => {
        content += `
          <div class="example-card">
            <h4>üíª ${example.title}</h4>
            <p style="margin-bottom: 15px;">${example.description}</p>
            
            ${example.code_snippet ? `
              <div class="code-example">
                <h5 style="margin-bottom: 10px;">Code Example:</h5>
                <pre style="white-space: pre-wrap; margin: 0;">${example.code_snippet}</pre>
              </div>
            ` : ''}
            
            <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin-top: 10px; border-left: 3px solid #ffc107;">
              <h5 style="margin-bottom: 8px;">üìù Explanation:</h5>
              <p style="margin: 0; line-height: 1.5;">${example.explanation}</p>
            </div>
          </div>
        `;
      });
      
      examplesContent.innerHTML = content;
    }

    // Display best practices
    function displayBestPractices() {
      const practicesContent = document.getElementById('practices-content');
      const practices = learningMaterial.content.best_practices;
      
      if (!practices || practices.length === 0) {
        practicesContent.innerHTML = '<p>Tidak ada praktik terbaik yang tersedia untuk materi ini.</p>';
        return;
      }
      
      const content = practices.map(practice => 
        `<div class="best-practice">‚úÖ ${practice}</div>`
      ).join('');
      
      practicesContent.innerHTML = content;
    }

    // Calculate learning progress
    function calculateProgress() {
      // Simple progress calculation based on sections viewed
      const sections = document.querySelectorAll('.content-section .content-header');
      const activeSections = document.querySelectorAll('.content-section .content-header.active');
      return Math.round((activeSections.length / sections.length) * 100);
    }

    // Toggle content sections
    function toggleSection(header) {
      const isActive = header.classList.contains('active');
      const contentBody = header.nextElementSibling;
      
      if (isActive) {
        header.classList.remove('active');
        contentBody.classList.remove('active');
      } else {
        header.classList.add('active');
        contentBody.classList.add('active');
      }
      
      // Update progress
      setTimeout(() => {
        const progress = calculateProgress();
        document.getElementById('progress-fill').style.width = `${progress}%`;
        document.getElementById('progress-text').textContent = `Progress: ${progress}% complete`;
      }, 100);
    }

    // API utility function
    async function makeAPICall(endpoint, method = 'GET', data = null) {
      try {
        const config = {
          method: method,
          headers: {
            'Content-Type': 'application/json',
          }
        };
        
        if (data) {
          config.body = JSON.stringify(data);
        }
        
        const response = await fetch(`${API_BASE_URL}${endpoint}`, config);
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        return await response.json();
      } catch (error) {
        console.error('API call failed:', error);
        throw error;
      }
    }

    // Chat functionality
    function handleChatKeyPress(event) {
      if (event.key === 'Enter') {
        sendMessage();
      }
    }

    async function sendMessage() {
      const input = document.getElementById('chat-input');
      const message = input.value.trim();
      
      if (!message) return;
      
      // Clear input
      input.value = '';
      
      // Add user message to chat
      addMessageToChat(message, 'user');
      
      // Show typing indicator
      showTypingIndicator();
      
      try {
        // Try to send to backend AI tutor
        const response = await makeAPICall('/chat', 'POST', {
          user_id: currentUser.user_id,
          material_id: learningMaterial.id,
          message: message
        });
        
        hideTypingIndicator();
        
        if (response && response.response) {
          addMessageToChat(response.response, 'ai');
        } else {
          throw new Error('No response from AI');
        }
      } catch (error) {
        console.log('Backend unavailable, using demo responses');
        hideTypingIndicator();
        
        // Generate demo AI response
        const aiResponse = generateDemoAIResponse(message);
        addMessageToChat(aiResponse, 'ai');
      }
    }

    function addMessageToChat(message, sender) {
      const chatContainer = document.getElementById('chat-container');
      const messageDiv = document.createElement('div');
      messageDiv.className = `chat-message ${sender}-message`;
      
      if (sender === 'user') {
        messageDiv.innerHTML = `<strong>You:</strong> ${message}`;
      } else {
        messageDiv.innerHTML = `<strong>AI Tutor:</strong> ${message}`;
      }
      
      chatContainer.appendChild(messageDiv);
      chatContainer.scrollTop = chatContainer.scrollHeight;
      
      // Store in chat history
      chatHistory.push({ message, sender });
    }

    function showTypingIndicator() {
      document.getElementById('typing-indicator').style.display = 'block';
      const chatContainer = document.getElementById('chat-container');
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    function hideTypingIndicator() {
      document.getElementById('typing-indicator').style.display = 'none';
    }

    // Generate demo AI responses
    function generateDemoAIResponse(userMessage) {
      const message = userMessage.toLowerCase();
      
      // Context-aware responses based on specialization
      const isDataEngineer = currentUser.specialization === 'data_engineer';
      const isDataAnalyst = currentUser.specialization === 'data_analyst';
      
      if (message.includes('explain') || message.includes('what is')) {
        if (isDataEngineer) {
          return "Pertanyaan Bagus! Dalam data engineering, penting untuk memahami arsitektur di baliknya. Mari saya jelaskan langkah demi langkah dengan contoh praktis yang mungkin Anda temukan dalam pipeline nyata...";
        } else if (isDataAnalyst) {
          return "Pertanyaan Bagus! Dalam analisis data, konsep ini sangat penting untuk mengekstrak insight bisnis. Mari saya jelaskan ini dengan contoh SQL praktis dan tunjukkan bagaimana ia diterapkan dalam skenario bisnis nyata...";
        } else {
          return "Pertanyaan Bagus! Dalam data science, konsep ini fundamental untuk memahami pola dalam data. Mari saya jelaskan ini dengan sudut pandang statistik dan tunjukkan bagaimana ia diterapkan dalam analisis nyata...";
        }
      }
      
      if (message.includes('example') || message.includes('show me')) {
        if (isDataEngineer) {
          return "Berikut adalah contoh praktis yang mungkin Anda temukan dalam produksi: Bayangkan Anda membangun pipeline data nyata untuk platform e-commerce. Anda perlu menangani data pesanan, peristiwa pengguna, dan pembaruan inventaris. Kuncinya adalah merancang untuk skala dan reliabilitas...";
        } else if (isDataAnalyst) {
          return "Mari saya berikan contoh nyata: Bayangkan Anda menganalisis kinerja penjualan untuk perusahaan ritel. Anda akan menulis query SQL untuk mengidentifikasi tren, menghitung metrik kunci, dan membuat laporan yang membantu manajemen membuat keputusan. Berikut adalah cara Anda akan menangani...";
        } else {
          return "Mari sayi berikan contoh nyata: Bayangkan Anda menganalisis data perilaku pelanggan. Anda akan mulai dengan memeriksa distribusi metrik kunci, mencari pola, dan mengidentifikasi potensi outlier. Berikut adalah cara Anda akan menangani...";
        }
      }
      
      if (message.includes('how') || message.includes('implement')) {
        return "Pertanyaan implementasi yang bagus! Pendekatan tergantung pada kasus penggunaan Anda, tetapi berikut adalah langkah-langkah dan praktik terbaik yang harus Anda ikuti...";
      }
      
      if (message.includes('best practice') || message.includes('recommend')) {
        return "Untuk praktik terbaik, saya selalu merekomendasikan memulai dari dasar. Berdasarkan level Anda saat ini, berikut adalah hal-hal yang paling penting untuk fokus sekarang...";
      }
      
      if (message.includes('difficult') || message.includes('hard') || message.includes('confused')) {
        return "Saya mengerti ini bisa menjadi sulit! Mari saya pecahkan menjadi bagian-bagian yang lebih kecil dan lebih mudah dikelola. Ingat, semua orang belajar dengan kecepatan mereka sendiri, dan itu baik untuk mengambil waktu untuk memahami konsep ini...";
      }
      
      if (message.includes('project') || message.includes('real world')) {
        if (isDataEngineer) {
          return "Untuk proyek nyata, Anda sering menangani data yang kotor, persyaratan yang berubah, dan tantangan skala. Berikut adalah apa yang saya sarankan untuk memulai untuk membangun pengalaman praktis...";
        } else if (isDataAnalyst) {
          return "Proyek analisis data nyata sangat menarik! Anda akan bekerja dengan pemangku kepentingan bisnis, membuat laporan, dan menjawab pertanyaan yang memacu keputusan. Berikut adalah cara untuk menangani proyek analisis Anda pertama...";
        } else {
          return "Proyek data science nyata sangat menarik! Mereka sering melibatkan pemangku kepentingan bisnis, data yang kotor, dan analisis iteratif. Berikut adalah cara untuk menangani proyek Anda pertama...";
        }
      }
      
      // Default responses
      const defaultResponses = [
        "Pertanyaan yang mendalam! Berdasarkan apa yang kita bahas dalam materi ini, berikut adalah apa yang saya pikirkan yang paling membantu untuk belajar Anda...",
        "Saya di sini untuk membantu Anda memahami ini lebih baik! Dapatkah Anda memberitahu saya bagian mana yang ingin saya jelaskan lebih lanjut?",
        "Bagus! Ini berhubungan langsung dengan apa yang kita pelajari. Mari saya sambungkan ini ke konsep dalam materi Anda saat ini...",
        "Saya melihat Anda berpikir kritis tentang topik ini. Itu adalah pendekatan yang tepat untuk menguasai konsep ini!"
      ];
      
      return defaultResponses[Math.floor(Math.random() * defaultResponses.length)];
    }

    // Navigation functions
    function takeQuiz() {
      // Create URL parameters for quiz page
      const params = new URLSearchParams({
        user_id: currentUser.user_id,
        username: currentUser.username,
        specialization: currentUser.specialization,
        level: currentUser.level,
        material_id: learningMaterial.id,
        from_learning: 'true'
      });
      
      window.location.href = `quiz.html?${params.toString()}`;
    }

    function goBack() {
      const params = new URLSearchParams({
        user_id: currentUser.user_id,
        username: currentUser.username,
        specialization: currentUser.specialization,
        level: currentUser.level,
        returning: 'true'
      });
      
      window.location.href = `course.html?${params.toString()}`;
    }

    function viewProgress() {
      const params = new URLSearchParams({
        user_id: currentUser.user_id,
        username: currentUser.username,
        specialization: currentUser.specialization,
        level: currentUser.level,
        score: currentUser.score
      });
      
      window.location.href = `profile.html?${params.toString()}`;
    }

    function nextModule() {
      // This would be implemented to load the next learning module
      alert('Fitur untuk memuat modul berikutnya akan diimplementasikan di sini! Untuk saat ini, Anda dapat mengambil kuis untuk menyelesaikan modul ini.');
    }

    // Auto-save progress periodically
    setInterval(() => {
      if (currentUser && learningMaterial) {
        const progress = calculateProgress();
        console.log(`Auto-saving progress: ${progress}%`);
        // In a real application, you would save this to the backend
      }
    }, 30000); // Save every 30 seconds
  </script>
</body>
</html>